#!/usr/bin/env bash

platform=`uname`
echo platform=${platform}
echo "running against commit: "`git log --oneline --no-decorate -n 1`

set -x
set -e

function _setup_client() {
    pushd client
    python3 -m venv env
    . env/bin/activate
    pip install --upgrade pip --progress-bar off
    pip install --upgrade setuptools wheel
    make setup

    deactivate
    popd
}

function _setup_ganache() {
    pushd zeth_contracts
    npm config set python python2.7
    npm config set engine-strict true
    npm config set unsafe-perm true
    npm install --unsafe-perm
    popd
}

function _ganache_is_active() {
    curl -sf \
         -H "Content-Type: application/json" \
         -X POST \
         --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[]}' \
         http://localhost:8545
}

function _start_ganache() {
    pushd zeth_contracts

    npm run testrpc > ganache.stdout &
    echo $! > ganache.pid

    # Wait for ganache to be active
    while ! _ganache_is_active ; do
        echo "_start_ganache: waiting for ganache ..."
        sleep 1
    done
    echo "_start_ganache: ganache is active"

    popd
}

function _stop_ganache() {
    pushd zeth_contracts
    if ! [ -e ganache.pid ] ; then
        echo "_stop_ganache: no PID file"
        return 1
    fi

    pid=`cat ganache.pid`
    while (kill "${pid}") ; do
        sleep 0.5
    done
    rm ganache.pid
    echo "_stop_ganache: ganache stopped"

    popd
}

function _prover_server_is_active() {
    # Assume the client env is active
    zeth get-verification-key
}

function _start_prover_server() {
    # Requires the client env (for _prover_server_is_active)
    . client/env/bin/activate
    pushd build

    ./prover_server/prover_server > prover_server.stdout &
    echo $! > prover_server.pid

    # Wait for prover_server to be active
    while ! _prover_server_is_active ; do
        echo "_start_prover_server: waiting for server ..."
        sleep 1
    done
    echo "_start_prover_server:: prover_server is active"

    popd # build
    deactivate
}

function _stop_prover_server() {
    pushd build

    if ! [ -e prover_server.pid ] ; then
        echo "_stop_prover_server: no PID file"
        return 1
    fi

    pid=`cat prover_server.pid`
    while (kill "${pid}") ; do
        sleep 0.5
    done
    rm prover_server.pid
    echo "_stop_prover_server:: prover_server stopped"

    popd # build
}

function _build_setup() {
    # Extra deps for native builds
    if [ "${platform}" == "Linux" ] ; then
        if (which apk) ; then
            # Packages already available in Docker build
            echo -n             # null op required for syntax
        else
            sudo apt install \
                 libboost-dev \
                 libboost-system-dev \
                 libboost-filesystem-dev \
                 libboost-program-options-dev \
                 libgmp-dev \
                 libprocps-dev \
                 libxslt1-dev \
                 pkg-config
        fi
    fi
}

function check_format() {
    scripts/format
    git diff --no-ext-diff | head -n 20 > format_errors
    num_lines=`cat format_errors | wc -l`
    if [ "${num_lines}" != "0" ] ; then
        echo CODE FORMATTING ERRORS:
        cat format_errors
        exit 1
    fi

    # Perform the check for copyright notices here
    scripts/check_copyright
}

function check_contracts() {

    # Setup the zeth_contracts dir
    _setup_ganache

    # Run checks in zeth_contracts
    pushd zeth_contracts
    npm run check
    popd # zeth_contracts

    # Run contract tests (in python)
    _setup_client

    _start_ganache

    pushd client
    . env/bin/activate
    make test_contracts
    deactivate
    popd

    _stop_ganache

}

function check_client() {
    _setup_client

    pushd client
    . env/bin/activate

    make check

    deactivate
    popd
}

function check_cpp() {
    apk add cppcheck
    cppcheck --version

    # Configure and run clang-tidy cppcheck
    mkdir -p build
    pushd build
    # cmake -DUSE_CPP_CHECK=ON -DUSE_CLANG_TIDY=ON ..
    # make VERBOSE=1 clang-tidy -j 5
    cmake -DUSE_CPP_CHECK=ON ..
    make VERBOSE=1 cppcheck -j 5
    popd
}

function mpc_tests() {

    # These commands are only for the GROTH16 config
    if ! [ "${CI_ZKSNARK}" == "GROTH16" ] ; then
        return
    fi
    if ! [ "${CI_CURVE}" == "ALT_BN128" ] ; then
        return
    fi

    # Setup the mpc python env and install dependencies
    scripts/mpc_setup

    # Execute checks on mpc python code
    pushd mpc
    . env/bin/activate
    make check
    deactivate
    popd

    # Execute the test scripts for pot-process, mpc, mpc server and client
    scripts/test_pot_process
    scripts/test_phase2
    scripts/test_mpc_contributors_from_csv
    scripts/test_mpc_server_phase2
}

function prover_tests() {

    # Native code is built.  Setup client and ganache.
    _setup_ganache
    _setup_client

    # Start servers
    _start_ganache
    _start_prover_server

    # Enter client env and run prover test scripts
    . client/env/bin/activate
    python -m test_commands.test_ether_mixing GROTH16
    python -m test_commands.test_erc_token_mixing GROTH16
    deactivate

    # Stop servers
    _stop_prover_server
    _stop_ganache
}

function integration_tests() {

    # Native code is built.  Setup client and ganache.
    _setup_ganache
    _setup_client

    # Start servers
    _start_ganache
    _start_prover_server

    # Enter client env and run client test script
    . client/env/bin/activate
    ./scripts/test_zeth_cli
    deactivate

    # Stop servers
    _stop_prover_server
    _stop_ganache
}

function build() {

    _build_setup

    # Additional compilation flags
    cxx_flags="-Werror"

    if [ "${platform}" == "Darwin" ] ; then
        openssl_path=$(brew --prefix openssl)
        export PATH="/usr/local/opt/llvm/bin:/usr/local/bin:${PATH}"
        export PKG_CONFIG_PATH="${openssl_path}/lib/pkgconfig"
        export LIBRARY_PATH="${openssl_path}/lib"
        export LDFLAGS="-L/usr/local/lib -L${openssl_path}/lib"
        export CPPFLAGS="-I/usr/local/include -I${openssl_path}/include"

        cxx_flags="${cxx_flags} -I${openssl_path}/include"
        cxx_flags="${cxx_flags} -Wno-deprecated-declarations"
    fi

    cmake_flags="-DCMAKE_BUILD_TYPE=${CI_CONFIG} -DZETH_SNARK=${CI_ZKSNARK}"
    cmake_flags="${cmake_flags} -DZETH_CURVE=${CI_CURVE}"
    # Switch off slow tests unless CI_FULL_TESTS == 1
    if ! [ "${CI_FULL_TESTS}" == "1" ] ; then
        cmake_flags="${cmake_flags} -DFAST_TESTS_ONLY=ON"
    fi
    # Use ccache if available
    if (which ccache) ; then
        cmake_flags="${cmake_flags} -DCMAKE_C_COMPILER_LAUNCHER=ccache"
    fi

    # Build and run unit tests
    . setup_env.sh
    mkdir -p build
    cd build
    cmake                                    \
        ${cmake_flags}                       \
        -DCMAKE_CXX_FLAGS="${cxx_flags}"     \
        ..

    make -j 2 VERBOSE=1 all build_tests
    CTEST_OUTPUT_ON_FAILURE=1 make -j 2 check
    cd ..

    if [ "${CI_MPC_TESTS}" == "1" ] ; then
        mpc_tests
    fi

    if [ "${CI_PROVER_TESTS}" == "1" ] ; then
        prover_tests
    fi

    if [ "${CI_INTEGRATION_TESTS}" == "1" ] ; then
        integration_tests
    fi
}

function ci_setup() {

    if [ "${platform}" == "Darwin" ] ; then
        # Some of these commands can fail (if packages are already installed,
        # etc), hence the `|| echo`.
        brew update || echo
        brew install \
             gmp \
             grpc \
             protobuf \
             boost \
             openssl \
             cmake \
             libtool \
             autoconf \
             automake \
             || echo
    fi

    # The base docker image we use is Alpine
    # See: https://www.alpinelinux.org/
    if [ "${platform}" == "Linux" ] ; then

        if (which apk) ; then
            apk add --update npm

            # `py3-virtualenv` depends on `python3`
            # which installs the latest version of python3
            # See: https://pkgs.alpinelinux.org/package/edge/main/x86/python3
            # https://build.alpinelinux.org/buildlogs/build-edge-x86/main/python3/python3-3.8.2-r6.log
            apk add \
                py3-virtualenv \
                libffi-dev \
                python3-dev

            # Install openssl for the mpc tests
            apk add openssl
        else
            sudo apt update
            sudo apt install python3-venv
        fi

    fi
}

ci_task=$1

echo ci_task = ${ci_task}
echo CI_CONFIG=${CI_CONFIG}
echo CI_ZKSNARK=${CI_ZKSNARK}
echo CI_CURVE=${CI_CURVE}
echo CI_CHECK_FORMAT=${CI_CHECK_FORMAT}
echo CI_EVENT_NAME=${CI_EVENT_NAME}
echo CI_FULL_TEST=${CI_FULL_TESTS}
echo CI_MPC_TESTS=${CI_MPC_TESTS}
echo CI_PROVER_TESTS=${CI_PROVER_TESTS}
echo CI_INTEGRATION_TESTS=${CI_INTEGRATION_TESTS}

if [ "${CI_CHECK_FORMAT}" == "1" ] ; then
    check_format
fi

if [ "${CI_ZKSNARK}" == "" ] ; then
    CI_ZKSNARK="GROTH16"
fi

if [ "${CI_CURVE}" == "" ] ; then
   CI_CURVE="ALT_BN128"
fi

# The CI_USE_DOCKER variable determines whether we should
# re-execute the script in the docker container with CI_USE_DOCKER=0
if [ "${CI_USE_DOCKER}" == "1" ] ; then
    docker pull clearmatics/zeth-base:latest
    docker build -f Dockerfile-dev -t zeth-dev .
    docker run \
           -t \
           -p 50051:50051 \
           --name zeth \
           --env CI_CONFIG=${CI_CONFIG} \
           --env CI_ZKSNARK=${CI_ZKSNARK} \
           --env CI_CURVE=${CI_CURVE} \
           --env CI_FULL_TESTS=${CI_FULL_TESTS} \
           --env CI_MPC_TESTS=${CI_MPC_TESTS} \
           --env CI_INTEGRATION_TESTS=${CI_INTEGRATION_TESTS} \
           zeth-dev:latest $0 ${ci_task}
else
    ci_setup
    ${ci_task}
fi
